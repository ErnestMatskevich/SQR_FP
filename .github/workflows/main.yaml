name: Statham project

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Run image
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: '1.7.1'
      - name: Install dependencies
        run: poetry install
      - name: Update dependencies
        run: poetry lock
      - name: Reliability check with pytest
        run: poetry run pytest --cov=app/ --cov-branch --cov-report=term --cov-fail-under=60
      - name: Security check with bandit
        run: poetry run bandit -r app
      - name: Usability check with Selenium
        run: cd app; poetry run python -m uvicorn api:app_api --reload
      - name: sel tests
        run: cd ..; poetry run pytest tests/ui_tests.py
      - name: Send custom Telegram message on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_USER_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: "Something went wrong in the CI process. Please check your code and fix the issue."

